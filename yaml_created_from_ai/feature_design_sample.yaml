# yaml-language-server: $schema=../schemas/feature_design.schema.json
# AI作成用YAML - このファイルをAIが編集します

meta:
  title: ユーザー通知機能
  type: feature_design
  version: 1.0.0
  status: draft
  author: 開発チーム
  created_at: "2026-01-29"
  updated_at: "2026-01-29"

background:
  purpose: ユーザーにリアルタイムで通知を届ける機能を実装する
  context: |
    現在、重要なイベント（新しいメッセージ、フォロー通知など）が
    発生してもユーザーがアプリを開くまで気づけない状態。
    ユーザーエンゲージメント向上のため、プッシュ通知機能が必要。
  issue_links:
    - https://github.com/example/issues/789
    - https://github.com/example/issues/790

scope:
  in:
    - プッシュ通知（Web/Mobile）
    - アプリ内通知
    - 通知設定画面
  out:
    - メール通知（別フェーズ）
    - SMS通知

requirements:
  functional:
    - id: FR-001
      description: ユーザーは新しいメッセージを受信したときにプッシュ通知を受け取れる
      priority: must
      acceptance_criteria:
        - メッセージ送信から3秒以内に通知が届く
        - 通知をタップするとメッセージ画面に遷移する
    - id: FR-002
      description: ユーザーはフォローされたときに通知を受け取れる
      priority: must
      acceptance_criteria:
        - フォロー操作から5秒以内に通知が届く
        - 通知にはフォロワーの名前とアイコンが表示される
    - id: FR-003
      description: ユーザーは通知のオン/オフを種類ごとに設定できる
      priority: should
      acceptance_criteria:
        - メッセージ通知、フォロー通知それぞれで設定可能
        - 設定は即座に反映される
    - id: FR-004
      description: ユーザーは通知履歴を一覧で確認できる
      priority: could
      acceptance_criteria:
        - 過去30日分の通知を表示
        - 未読/既読のフィルタリングが可能

  non_functional:
    - id: NFR-001
      category: performance
      description: 通知の配信遅延は5秒以内
      metric: 99パーセンタイルで5秒以内
    - id: NFR-002
      category: availability
      description: 通知サービスの可用性99.9%
      metric: 月間ダウンタイム43分以内
    - id: NFR-003
      category: scalability
      description: 同時接続10万ユーザーをサポート
      metric: WebSocket接続数

architecture:
  overview: |
    WebSocketを使用したリアルタイム通知基盤を構築。
    イベント駆動アーキテクチャでスケーラビリティを確保。
  patterns:
    - Publisher-Subscriber
    - Event Sourcing
    - CQRS
  decisions:
    - title: WebSocket vs Server-Sent Events
      context: リアルタイム通信の方式を選定する必要がある
      decision: WebSocketを採用
      rationale: 双方向通信が可能で、将来的な機能拡張に対応しやすい
      alternatives:
        - Server-Sent Events（単方向のみ）
        - Long Polling（効率が悪い）
    - title: 通知キューの選定
      context: 大量の通知を効率的に処理する必要がある
      decision: Amazon SQS + SNSを採用
      rationale: マネージドサービスで運用負荷が低く、スケーラビリティに優れる
      alternatives:
        - RabbitMQ（運用コスト高）
        - Kafka（オーバースペック）

components:
  - name: NotificationService
    responsibility: 通知の生成と配信管理
    dependencies:
      - MessageQueue
      - UserPreferenceStore
    interfaces:
      - sendNotification
      - getNotificationHistory
  - name: WebSocketGateway
    responsibility: WebSocket接続の管理
    dependencies:
      - NotificationService
    interfaces:
      - connect
      - disconnect
      - broadcast
  - name: MessageQueue
    responsibility: 通知メッセージのキューイング
    dependencies: []
    interfaces:
      - enqueue
      - dequeue
  - name: UserPreferenceStore
    responsibility: ユーザーの通知設定を管理
    dependencies: []
    interfaces:
      - getPreferences
      - updatePreferences

milestones:
  - name: Phase 1 - 基盤構築
    deliverables:
      - WebSocket基盤の構築
      - 通知サービスのコア実装
      - 開発環境での動作確認
  - name: Phase 2 - 機能実装
    deliverables:
      - メッセージ通知の実装
      - フォロー通知の実装
      - 通知設定画面の実装
  - name: Phase 3 - 本番リリース
    deliverables:
      - 負荷テスト完了
      - 本番環境へのデプロイ
      - モニタリング設定

risks:
  - risk: WebSocket接続数の急増による負荷
    severity: high
    probability: medium
    mitigation: オートスケーリングの設定と、接続数のモニタリングアラート

  - risk: 通知の配信遅延
    severity: medium
    probability: medium
    mitigation: キューの並列処理数を調整可能にし、ボトルネックを監視

  - risk: プッシュ通知の誤配信
    severity: high
    probability: low
    mitigation: 配信前の検証ロジックと、緊急停止機能の実装

testing:
  unit_tests:
    - NotificationServiceの通知生成ロジック
    - UserPreferenceStoreの設定取得/更新
    - WebSocket接続管理
  integration_tests:
    - エンドツーエンドの通知配信フロー
    - 複数デバイスへの同時配信
    - 通知設定の反映確認
  regression_tests:
    - 既存機能への影響がないこと
    - パフォーマンス要件を満たすこと
