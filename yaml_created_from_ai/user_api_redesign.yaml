# yaml-language-server: $schema=../schemas/api_design.schema.json
# AI作成用YAML - このファイルをAIが編集します

meta:
  title: ユーザー情報取得API改修
  type: api_design
  version: 1.0.0
  status: draft
  author: 開発チーム
  created_at: "2026-01-29"
  updated_at: "2026-01-29"

target:
  api_name: ユーザー情報取得API
  endpoint: /api/v1/users/{user_id}
  method: GET
  current_version: v1

background:
  purpose: パフォーマンス改善とレスポンス形式の最適化
  issue_links:
    - https://github.com/example/issues/123
    - https://github.com/example/issues/456
  context: |
    現行APIはレスポンスに不要なフィールドが多く、
    クライアント側でのパース処理が重くなっている。
    また、N+1問題によりレスポンスタイムが遅い。

as_is:
  description: ユーザー情報と関連データを全て返却している
  request:
    headers:
      - name: Authorization
        type: string
        required: true
        description: Bearer トークン
    query_params:
      - name: include
        type: string
        required: false
        description: 関連データの指定（カンマ区切り）
        example: "posts,comments,followers"
  response:
    status_codes:
      - code: 200
        description: 成功
      - code: 404
        description: ユーザーが見つからない
    body:
      - name: id
        type: integer
        description: ユーザーID
      - name: name
        type: string
        description: ユーザー名
      - name: email
        type: string
        description: メールアドレス
      - name: posts
        type: array
        description: 投稿一覧（全件）
      - name: comments
        type: array
        description: コメント一覧（全件）
      - name: followers
        type: array
        description: フォロワー一覧（全件）
  issues:
    - 関連データが全件返却され、レスポンスが大きい
    - N+1クエリが発生している
    - 不要なフィールドも常に返却される

to_be:
  description: 必要なフィールドのみを選択的に返却し、関連データはページネーション対応
  request:
    headers:
      - name: Authorization
        type: string
        required: true
        description: Bearer トークン
    query_params:
      - name: fields
        type: string
        required: false
        description: 取得するフィールドの指定（カンマ区切り）
        example: "id,name,email"
      - name: include
        type: string
        required: false
        description: 関連データの指定（カンマ区切り）
        example: "posts,followers"
      - name: page
        type: integer
        required: false
        description: 関連データのページ番号
        example: 1
      - name: per_page
        type: integer
        required: false
        description: 関連データの1ページあたりの件数
        example: 20
  response:
    status_codes:
      - code: 200
        description: 成功
      - code: 404
        description: ユーザーが見つからない
      - code: 400
        description: 不正なパラメータ
    body:
      - name: id
        type: integer
        description: ユーザーID
      - name: name
        type: string
        description: ユーザー名
      - name: email
        type: string
        description: メールアドレス（fieldsで指定時のみ）
      - name: _embedded
        type: object
        description: 関連データ（includeで指定時のみ）
      - name: _links
        type: object
        description: ページネーションリンク

changes:
  - type: add
    target: fields パラメータ
    description: 取得するフィールドを選択できるようにする
    reason: 不要なデータ転送を削減するため
    breaking: false

  - type: add
    target: page, per_page パラメータ
    description: 関連データのページネーションを追加
    reason: 大量データの分割取得を可能にするため
    breaking: false

  - type: modify
    target: レスポンス構造
    description: 関連データを _embedded 配下に移動
    reason: HAL形式に準拠し、構造を明確化するため
    breaking: true

  - type: add
    target: _links フィールド
    description: ページネーション用のリンクを追加
    reason: クライアントがページ遷移しやすくするため
    breaking: false

  - type: deprecate
    target: include パラメータの旧形式
    description: 全件取得の動作を非推奨化
    reason: パフォーマンス問題の原因となるため
    breaking: false

impact:
  clients:
    - Web フロントエンド（React）
    - モバイルアプリ（iOS/Android）
    - 管理画面
  databases:
    - users テーブル
    - posts テーブル
    - followers テーブル
  dependencies:
    - 認証サービス
    - キャッシュサービス（Redis）

migration:
  strategy: versioning
  steps:
    - order: 1
      description: v2エンドポイントを新規作成し、並行稼働開始
      rollback: v2エンドポイントを削除
    - order: 2
      description: クライアントを順次v2に移行（フィーチャーフラグ使用）
      rollback: フィーチャーフラグをOFFにしてv1に戻す
    - order: 3
      description: v1エンドポイントを非推奨化（Deprecation警告ヘッダー追加）
      rollback: 警告ヘッダーを削除
    - order: 4
      description: 移行完了後、v1エンドポイントを削除
      rollback: v1エンドポイントを復活
  rollback_plan: |
    全ステップでロールバック可能な状態を維持。
    問題発生時は直前のステップに戻す。

risks:
  - risk: 既存クライアントが破壊的変更の影響を受ける
    severity: high
    probability: medium
    mitigation: バージョニングで並行稼働し、移行期間を十分に確保

  - risk: ページネーション導入によりクライアント側の実装変更が必要
    severity: medium
    probability: high
    mitigation: 移行ガイドとサンプルコードを提供

  - risk: キャッシュ戦略の見直しが必要
    severity: medium
    probability: medium
    mitigation: フィールド選択に対応したキャッシュキー設計を事前に実施

testing:
  unit_tests:
    - fields パラメータによるフィールドフィルタリング
    - ページネーションの境界値テスト
    - 不正パラメータのバリデーション
  integration_tests:
    - 認証サービスとの連携
    - キャッシュの動作確認
    - データベースクエリの最適化確認
  regression_tests:
    - 既存のv1 APIの動作に影響がないこと
    - パフォーマンス要件を満たすこと
