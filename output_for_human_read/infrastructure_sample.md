# Kubernetes移行プロジェクト

**タイプ:** 🏗️ インフラ構築 | **ステータス:** 🔵 Draft | **バージョン:** 1.0.0
**作成者:** インフラチーム | **作成日:** 2026-01-29 | **更新日:** 2026-01-29

---

## 背景・目的

**目的:** EC2ベースのインフラをKubernetesに移行し、運用効率とスケーラビリティを向上

### 背景

現在のEC2ベースのインフラは手動でのスケーリングが必要で、
デプロイに時間がかかっている。Kubernetesに移行することで
オートスケーリング、ローリングデプロイ、自己修復機能を実現する。

### 関連リンク

- https://github.com/example/issues/100
- https://jira.example.com/browse/INFRA-500

## スコープ

### 対象

- ✅ APIサーバー（3サービス）
- ✅ バックグラウンドワーカー
- ✅ 監視・ログ基盤

### 対象外

- ❌ データベース（RDSのまま維持）
- ❌ CDN設定

## 現状のインフラ構成

EC2インスタンスでの手動運用

### コンポーネント

| 名前 | 種別 | 技術 | 説明 |
|------|------|------|------|
| API Server | server | EC2 (t3.large) | 3台構成、ALB経由でロードバランス |
| Worker | server | EC2 (t3.medium) | 2台構成、SQSからジョブを取得 |
| RDS | database | Aurora MySQL | マルチAZ構成 |
| ElastiCache | cache | Redis | セッションストア |

### 問題点

- ⚠️ スケーリングに10分以上かかる
- ⚠️ デプロイ時に5分程度のダウンタイムが発生
- ⚠️ サーバー障害時の自動復旧ができない

## 目標のインフラ構成

EKS上でのコンテナオーケストレーション

### コンポーネント

| 名前 | 種別 | 技術 | 説明 |
|------|------|------|------|
| API Server | container | EKS (Kubernetes) | Deployment + HPA、最小3Pod |
| Worker | container | EKS (Kubernetes) | Deployment + KEDA、イベント駆動スケーリング |
| Ingress | network | AWS ALB Ingress Controller | パスベースルーティング |
| RDS | database | Aurora MySQL | 既存のまま維持 |
| ElastiCache | cache | Redis | 既存のまま維持 |

### 期待効果

- ✅ オートスケーリングで負荷に自動対応
- ✅ ローリングデプロイでダウンタイムゼロ
- ✅ Pod障害時の自動復旧
- ✅ インフラのコード化（GitOps）

## リソース計画

### コンピュート

| 名前 | タイプ | 数量 | CPU | メモリ | ストレージ |
|------|--------|------|-----|--------|-----------|
| EKS Node Group | t3.large | 3 | 2 vCPU | 8 GB | 50 GB |
| EKS Node Group (Worker) | t3.medium | 2 | 2 vCPU | 4 GB | 30 GB |

### マネージドサービス

| 名前 | プロバイダー | サービス種別 |
|------|-------------|-------------|
| EKS | AWS | Managed Kubernetes |
| ECR | AWS | Container Registry |
| CloudWatch | AWS | Monitoring |

## セキュリティ設計

**認証:** IAM + OIDC Provider

**認可:** Kubernetes RBAC

### 暗号化

- **保存時:** EBS暗号化 (AWS KMS)
- **通信時:** TLS 1.3

### 準拠規格

- SOC 2
- ISO 27001

## 監視設計

### メトリクス

| メトリクス | 閾値 | アラート条件 |
|-----------|------|-------------|
| Pod CPU使用率 | 80% | 5分間平均が閾値超過 |
| Pod Memory使用率 | 85% | 5分間平均が閾値超過 |
| API レスポンスタイム | 500ms | p99が閾値超過 |
| Pod再起動回数 | 3回/時 | 閾値超過 |

### ログ設定

- **保存先:** CloudWatch Logs
- **保持期間:** 30日

## 移行計画

**移行戦略:** 🔵🟢 ブルー/グリーン

**想定ダウンタイム:** ゼロダウンタイム（ブルー/グリーンデプロイ）

### 移行ステップ

**Step 1:** EKSクラスター構築とネットワーク設定
  - 🔙 ロールバック: クラスター削除

**Step 2:** CI/CDパイプラインの構築（GitHub Actions + ArgoCD）
  - 🔙 ロールバック: 旧デプロイパイプラインに戻す

**Step 3:** ステージング環境での動作検証
  - 🔙 ロールバック: 該当なし

**Step 4:** 本番環境へのブルー/グリーンデプロイ（10%トラフィック）
  - 🔙 ロールバック: トラフィックを旧環境に100%戻す

**Step 5:** トラフィックを段階的に移行（10% → 50% → 100%）
  - 🔙 ロールバック: トラフィック比率を戻す

**Step 6:** 旧EC2環境の停止・削除
  - 🔙 ロールバック: EC2インスタンスを再起動

### 全体ロールバック計画

トラフィックをALBのターゲットグループで制御しているため、
問題発生時は即座に旧環境にトラフィックを戻すことが可能。
最悪の場合でも5分以内にロールバック完了。

## コスト見積もり

**月額概算:** $2,500

### 内訳

| 項目 | コスト |
|------|--------|
| EKS Control Plane | $73 |
| EC2 (Node Group) | $500 |
| ALB | $50 |
| CloudWatch | $100 |
| データ転送 | $200 |
| その他（ECR, Secrets Manager等） | $77 |

**備考:** 現行のEC2環境（月額$2,200）と比較して約$300増加だが、
運用工数削減とスケーラビリティ向上を考慮するとROIは良好。


## リスクと対策

| リスク | 深刻度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Kubernetes学習コスト | 🟡 中 | high | チームへのトレーニング実施、ドキュメント整備 |
| 移行中のサービス障害 | 🟠 高 | low | ブルー/グリーンデプロイで即座にロールバック可能 |
| 想定外のコスト増加 | 🟡 中 | medium | コストアラートの設定、リソース使用状況の定期レビュー |

## テスト計画

### ユニットテスト

- [ ] Kubernetesマニフェストのバリデーション
- [ ] Helmチャートのテスト

### 結合テスト

- [ ] クラスター内サービス間通信
- [ ] オートスケーリングの動作確認
- [ ] ローリングデプロイの動作確認

### 回帰テスト

- [ ] APIの機能テスト
- [ ] 負荷テスト（現行同等の負荷を処理できること）
