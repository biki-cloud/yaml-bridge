# ユーザー通知機能

**タイプ:** ✨ 新機能設計 | **ステータス:** 🔵 Draft | **バージョン:** 1.0.0
**作成者:** 開発チーム | **作成日:** 2026-01-29 | **更新日:** 2026-01-29

---

## 背景・目的

**目的:** ユーザーにリアルタイムで通知を届ける機能を実装する

### 背景

現在、重要なイベント（新しいメッセージ、フォロー通知など）が
発生してもユーザーがアプリを開くまで気づけない状態。
ユーザーエンゲージメント向上のため、プッシュ通知機能が必要。

### 関連リンク

- https://github.com/example/issues/789
- https://github.com/example/issues/790

## スコープ

### 対象

- ✅ プッシュ通知（Web/Mobile）
- ✅ アプリ内通知
- ✅ 通知設定画面

### 対象外

- ❌ メール通知（別フェーズ）
- ❌ SMS通知

## 要件定義

### 機能要件

| ID | 説明 | 優先度 |
|----|------|--------|
| FR-001 | ユーザーは新しいメッセージを受信したときにプッシュ通知を受け取れる | 🔴 Must |
| FR-002 | ユーザーはフォローされたときに通知を受け取れる | 🔴 Must |
| FR-003 | ユーザーは通知のオン/オフを種類ごとに設定できる | 🟠 Should |
| FR-004 | ユーザーは通知履歴を一覧で確認できる | 🟡 Could |

**FR-001 受け入れ条件:**

- [ ] メッセージ送信から3秒以内に通知が届く
- [ ] 通知をタップするとメッセージ画面に遷移する

**FR-002 受け入れ条件:**

- [ ] フォロー操作から5秒以内に通知が届く
- [ ] 通知にはフォロワーの名前とアイコンが表示される

**FR-003 受け入れ条件:**

- [ ] メッセージ通知、フォロー通知それぞれで設定可能
- [ ] 設定は即座に反映される

**FR-004 受け入れ条件:**

- [ ] 過去30日分の通知を表示
- [ ] 未読/既読のフィルタリングが可能

### 非機能要件

| ID | カテゴリ | 説明 | 測定指標 |
|----|----------|------|----------|
| NFR-001 | performance | 通知の配信遅延は5秒以内 | 99パーセンタイルで5秒以内 |
| NFR-002 | availability | 通知サービスの可用性99.9% | 月間ダウンタイム43分以内 |
| NFR-003 | scalability | 同時接続10万ユーザーをサポート | WebSocket接続数 |

## アーキテクチャ

WebSocketを使用したリアルタイム通知基盤を構築。
イベント駆動アーキテクチャでスケーラビリティを確保。


### デザインパターン

- Publisher-Subscriber
- Event Sourcing
- CQRS

### アーキテクチャ決定 (ADR)

#### ADR-1: WebSocket vs Server-Sent Events

**背景:** リアルタイム通信の方式を選定する必要がある

**決定:** WebSocketを採用

**理由:** 双方向通信が可能で、将来的な機能拡張に対応しやすい

**検討した代替案:**
- Server-Sent Events（単方向のみ）
- Long Polling（効率が悪い）

#### ADR-2: 通知キューの選定

**背景:** 大量の通知を効率的に処理する必要がある

**決定:** Amazon SQS + SNSを採用

**理由:** マネージドサービスで運用負荷が低く、スケーラビリティに優れる

**検討した代替案:**
- RabbitMQ（運用コスト高）
- Kafka（オーバースペック）

## コンポーネント

| コンポーネント | 責務 | 依存 |
|---------------|------|------|
| NotificationService | 通知の生成と配信管理 | MessageQueue, UserPreferenceStore |
| WebSocketGateway | WebSocket接続の管理 | NotificationService |
| MessageQueue | 通知メッセージのキューイング | - |
| UserPreferenceStore | ユーザーの通知設定を管理 | - |

## マイルストーン

### 1. Phase 1 - 基盤構築

**成果物:**
- WebSocket基盤の構築
- 通知サービスのコア実装
- 開発環境での動作確認

### 2. Phase 2 - 機能実装

**成果物:**
- メッセージ通知の実装
- フォロー通知の実装
- 通知設定画面の実装

### 3. Phase 3 - 本番リリース

**成果物:**
- 負荷テスト完了
- 本番環境へのデプロイ
- モニタリング設定

## リスクと対策

| リスク | 深刻度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| WebSocket接続数の急増による負荷 | 🟠 高 | medium | オートスケーリングの設定と、接続数のモニタリングアラート |
| 通知の配信遅延 | 🟡 中 | medium | キューの並列処理数を調整可能にし、ボトルネックを監視 |
| プッシュ通知の誤配信 | 🟠 高 | low | 配信前の検証ロジックと、緊急停止機能の実装 |

## テスト計画

### ユニットテスト

- [ ] NotificationServiceの通知生成ロジック
- [ ] UserPreferenceStoreの設定取得/更新
- [ ] WebSocket接続管理

### 結合テスト

- [ ] エンドツーエンドの通知配信フロー
- [ ] 複数デバイスへの同時配信
- [ ] 通知設定の反映確認

### 回帰テスト

- [ ] 既存機能への影響がないこと
- [ ] パフォーマンス要件を満たすこと
