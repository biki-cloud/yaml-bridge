# ユーザー情報取得API改修

**タイプ:** 🔌 API設計 | **ステータス:** 🔵 Draft | **バージョン:** 1.0.0
**作成者:** 開発チーム | **作成日:** 2026-01-29 | **更新日:** 2026-01-29

---

## 改修対象

| 項目 | 値 |
|------|-----|
| API名 | ユーザー情報取得API |
| エンドポイント | `/api/v1/users/{user_id}` |
| メソッド | `GET` |
| 現行バージョン | v1 |

## 背景・目的

**目的:** パフォーマンス改善とレスポンス形式の最適化

### 背景

現行APIはレスポンスに不要なフィールドが多く、
クライアント側でのパース処理が重くなっている。
また、N+1問題によりレスポンスタイムが遅い。

### 関連リンク

- https://github.com/example/issues/123
- https://github.com/example/issues/456

## 現状 → 改修後

### 現状 (As-Is)

> ユーザー情報と関連データを全て返却している

**問題点:**

- ⚠️ 関連データが全件返却され、レスポンスが大きい
- ⚠️ N+1クエリが発生している
- ⚠️ 不要なフィールドも常に返却される

#### リクエスト

**ヘッダー:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `Authorization` | string | ✅ | Bearer トークン |

**クエリパラメータ:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `include` | string | - | 関連データの指定（カンマ区切り） (例: `posts,comments,followers`) |

#### レスポンス

**ステータスコード:**

- `200`: 成功
- `404`: ユーザーが見つからない

**レスポンスボディ:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `id` | integer | - | ユーザーID |
| `name` | string | - | ユーザー名 |
| `email` | string | - | メールアドレス |
| `posts` | array | - | 投稿一覧（全件） |
| `comments` | array | - | コメント一覧（全件） |
| `followers` | array | - | フォロワー一覧（全件） |

### 改修後 (To-Be)

> 必要なフィールドのみを選択的に返却し、関連データはページネーション対応

#### リクエスト

**ヘッダー:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `Authorization` | string | ✅ | Bearer トークン |

**クエリパラメータ:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `fields` | string | - | 取得するフィールドの指定（カンマ区切り） (例: `id,name,email`) |
| `include` | string | - | 関連データの指定（カンマ区切り） (例: `posts,followers`) |
| `page` | integer | - | 関連データのページ番号 (例: `1`) |
| `per_page` | integer | - | 関連データの1ページあたりの件数 (例: `20`) |

#### レスポンス

**ステータスコード:**

- `200`: 成功
- `404`: ユーザーが見つからない
- `400`: 不正なパラメータ

**レスポンスボディ:**

| 名前 | 型 | 必須 | 説明 |
|------|-----|------|------|
| `id` | integer | - | ユーザーID |
| `name` | string | - | ユーザー名 |
| `email` | string | - | メールアドレス（fieldsで指定時のみ） |
| `_embedded` | object | - | 関連データ（includeで指定時のみ） |
| `_links` | object | - | ページネーションリンク |

## 変更内容

> ⚠️ **破壊的変更があります**

| 種類 | 対象 | 内容 | 理由 | 破壊的 |
|------|------|------|------|--------|
| ➕ 追加 | fields パラメータ | 取得するフィールドを選択できるようにする | 不要なデータ転送を削減するため | No |
| ➕ 追加 | page, per_page パラメータ | 関連データのページネーションを追加 | 大量データの分割取得を可能にするため | No |
| ✏️ 変更 | レスポンス構造 | 関連データを _embedded 配下に移動 | HAL形式に準拠し、構造を明確化するため | ⚠️ Yes |
| ➕ 追加 | _links フィールド | ページネーション用のリンクを追加 | クライアントがページ遷移しやすくするため | No |
| ⚠️ 非推奨化 | include パラメータの旧形式 | 全件取得の動作を非推奨化 | パフォーマンス問題の原因となるため | No |

## 影響範囲

### 影響を受けるクライアント

- Web フロントエンド（React）
- モバイルアプリ（iOS/Android）
- 管理画面

### 影響を受けるデータベース

- users テーブル
- posts テーブル
- followers テーブル

### 依存サービス

- 認証サービス
- キャッシュサービス（Redis）

## 移行計画

**移行戦略:** 🔢 バージョニング

### 移行ステップ

**Step 1:** v2エンドポイントを新規作成し、並行稼働開始
  - 🔙 ロールバック: v2エンドポイントを削除

**Step 2:** クライアントを順次v2に移行（フィーチャーフラグ使用）
  - 🔙 ロールバック: フィーチャーフラグをOFFにしてv1に戻す

**Step 3:** v1エンドポイントを非推奨化（Deprecation警告ヘッダー追加）
  - 🔙 ロールバック: 警告ヘッダーを削除

**Step 4:** 移行完了後、v1エンドポイントを削除
  - 🔙 ロールバック: v1エンドポイントを復活

### 全体ロールバック計画

全ステップでロールバック可能な状態を維持。
問題発生時は直前のステップに戻す。

## リスクと対策

| リスク | 深刻度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 既存クライアントが破壊的変更の影響を受ける | 🟠 高 | medium | バージョニングで並行稼働し、移行期間を十分に確保 |
| ページネーション導入によりクライアント側の実装変更が必要 | 🟡 中 | high | 移行ガイドとサンプルコードを提供 |
| キャッシュ戦略の見直しが必要 | 🟡 中 | medium | フィールド選択に対応したキャッシュキー設計を事前に実施 |

## テスト計画

### ユニットテスト

- [ ] fields パラメータによるフィールドフィルタリング
- [ ] ページネーションの境界値テスト
- [ ] 不正パラメータのバリデーション

### 結合テスト

- [ ] 認証サービスとの連携
- [ ] キャッシュの動作確認
- [ ] データベースクエリの最適化確認

### 回帰テスト

- [ ] 既存のv1 APIの動作に影響がないこと
- [ ] パフォーマンス要件を満たすこと
