{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "bugfix.schema.json",
  "title": "バグ修正設計ドキュメント",
  "description": "バグ修正の設計を記述するためのスキーマ",
  "allOf": [
    { "$ref": "base.schema.json" }
  ],
  "type": "object",
  "required": ["meta", "background", "symptom", "root_cause", "fix"],
  "properties": {
    "meta": {
      "properties": {
        "type": {
          "const": "bugfix"
        }
      }
    },
    "symptom": {
      "type": "object",
      "description": "症状（バグの現象）",
      "required": ["description"],
      "properties": {
        "description": {
          "type": "string",
          "description": "症状の説明"
        },
        "frequency": {
          "type": "string",
          "enum": ["always", "often", "sometimes", "rare"],
          "description": "発生頻度"
        },
        "impact": {
          "type": "string",
          "enum": ["critical", "major", "minor", "trivial"],
          "description": "影響度"
        },
        "affected_users": {
          "type": "string",
          "description": "影響を受けるユーザー/範囲"
        },
        "reproduction_steps": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "再現手順"
        },
        "expected_behavior": {
          "type": "string",
          "description": "期待される動作"
        },
        "actual_behavior": {
          "type": "string",
          "description": "実際の動作"
        },
        "error_logs": {
          "type": "string",
          "description": "エラーログ/スタックトレース"
        }
      }
    },
    "root_cause": {
      "type": "object",
      "description": "根本原因",
      "required": ["description"],
      "properties": {
        "description": {
          "type": "string",
          "description": "根本原因の説明"
        },
        "location": {
          "type": "object",
          "description": "問題箇所",
          "properties": {
            "file": {
              "type": "string",
              "description": "ファイルパス"
            },
            "line": {
              "type": "integer",
              "description": "行番号"
            },
            "function": {
              "type": "string",
              "description": "関数/メソッド名"
            }
          }
        },
        "why_analysis": {
          "type": "array",
          "description": "なぜなぜ分析（5 Whys）",
          "items": {
            "type": "object",
            "properties": {
              "why": {
                "type": "string",
                "description": "なぜ？"
              },
              "answer": {
                "type": "string",
                "description": "回答"
              }
            }
          }
        },
        "introduced_by": {
          "type": "string",
          "description": "バグが混入したコミット/PR"
        }
      }
    },
    "fix": {
      "type": "object",
      "description": "修正内容",
      "required": ["approach"],
      "properties": {
        "approach": {
          "type": "string",
          "description": "修正アプローチ"
        },
        "changes": {
          "type": "array",
          "description": "変更内容",
          "items": {
            "type": "object",
            "required": ["file", "description"],
            "properties": {
              "file": {
                "type": "string",
                "description": "変更ファイル"
              },
              "description": {
                "type": "string",
                "description": "変更内容"
              },
              "before": {
                "type": "string",
                "description": "修正前コード"
              },
              "after": {
                "type": "string",
                "description": "修正後コード"
              }
            }
          }
        },
        "side_effects": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "想定される副作用"
        }
      }
    },
    "verification": {
      "type": "object",
      "description": "検証計画",
      "properties": {
        "test_cases": {
          "type": "array",
          "description": "テストケース",
          "items": {
            "type": "object",
            "required": ["description", "expected_result"],
            "properties": {
              "description": {
                "type": "string",
                "description": "テスト内容"
              },
              "steps": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "テスト手順"
              },
              "expected_result": {
                "type": "string",
                "description": "期待結果"
              }
            }
          }
        },
        "regression_scope": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "回帰テスト範囲"
        },
        "environments": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "検証環境"
        }
      }
    },
    "prevention": {
      "type": "object",
      "description": "再発防止策",
      "properties": {
        "immediate_actions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "即時対応"
        },
        "long_term_actions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "長期対応"
        }
      }
    }
  }
}
