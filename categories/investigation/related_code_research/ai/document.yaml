meta:
  title: "認証周辺の関連コード調査"
  category: investigation
  doc_type: related_code_research
  status: wip
  version: "1.0.0"
  author: "山田太郎"
  created_at: "2024-01-18"

target:
  description: |
    認証・ユーザー管理の改修にあたり、認証モジュールの呼び出し元および
    ユーザーAPI周辺のコードを調査する。
  project_context: "ユーザー管理システム刷新プロジェクト（認証機能改修）"
  search_scope:
    - "src/auth/"
    - "src/middleware/"
    - "src/routes/users.ts"
    - "src/routes/auth.ts"

questions:
  - id: Q1
    question: "認証ミドルウェアはどこで適用されているか？"
    priority: high
  - id: Q2
    question: "ユーザーAPIでトークン検証はどう行われているか？"
    priority: high

findings:
  - question_id: Q1
    description: |
      各ルートで個別に tokenVerify() を呼んでいる。共通の requireAuth ミドルウェアは存在しない。
      ルート追加時に検証の付け忘れが発生しうる。
    location: "src/routes/auth.ts, src/routes/users.ts"
    relevance: high
  - question_id: Q2
    description: |
      ユーザー一覧・詳細取得では、リクエストヘッダーから Bearer トークンを取り出し、
      tokenVerify() で検証している。検証失敗時は 401 を返す。ロールによる認可は未実装。
    location: "src/routes/users.ts"
    relevance: high
  - question_id: Q1
    description: |
      tokenVerify は JWT の署名・有効期限のみ検証。Redis でのトークン無効化（ログアウト済み）は未チェック。
    location: "src/auth/token.ts"
    relevance: medium

conclusions:
  - "認証ミドルウェアの共通化（requireAuth）を実装し、ルートではミドルウェアを適用するだけにする推奨（TD-002）。"
  - "ログアウト済みトークンの無効化チェックは、Redis トークンストア実装時に追加する。"

next_actions:
  - action: "requireAuth ミドルウェアの設計・実装を実装計画に反映する"
    priority: must
  - action: "トークン無効化チェックをトークンストア実装と同時に追加する"
    priority: should

references:
  - title: 認証モジュールのコード理解
    url: categories/investigation/code_understanding/ai/document.yaml
  - title: 実装計画
    url: categories/development/implementation_plan/ai/document.yaml
  - title: 設計タスク
    url: categories/design/tasks/ai/document.yaml
