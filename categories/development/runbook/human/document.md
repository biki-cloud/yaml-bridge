# 運用ランブック

**タイプ:** 📘 ランブック・運用手順 | **ステータス:** 🔄 WIP | **バージョン:** 1.0.0
**作成者:** 山田太郎

## 背景

認証・ユーザー管理システムの本番運用・障害対応手順を一覧化する。


## 目的

起動・デプロイ・ロールバック・障害時手順を一覧化し、運用・監査で参照できるようにする。

### 関連ドキュメント

- [プロジェクト概要](../../../overview/project_summary/human/document.md)
- [環境・インフラ](../../environment/human/document.md)

**対象環境:** 本番・ステージング

**対象システム:** 認証サービス・ユーザープロファイルAPI

## 手順一覧

| ID | 種別 | タイトル | 想定時間 |
|----|------|----------|----------|
| RB-001 | デプロイ | ステージングデプロイ | 10分 |
| RB-002 | ロールバック | 本番ロールバック（フィーチャーフラグOFF） | 15分 |
| RB-003 | 障害対応 | Redis 接続障害時の初動 | 30分 |

## RB-001: ステージングデプロイ
**種別:** デプロイ

**事前条件:** main にマージ済み。CI がグリーン。

### 手順

**1. GitHub Actions の「Deploy Staging」ワークフローを手動実行**

   期待結果: ワークフローが成功し、ステージングに最新イメージがデプロイされる
   備考: 失敗時は Actions ログで原因確認

**2. ヘルスチェックエンドポイントに GET でアクセス**

   期待結果: 200 OK。レスポンスに version が含まれる
   備考: https://staging.user-mgmt.example.com/health

**3. ログインAPIを 1 回叩いて動作確認**

   期待結果: 401（未認証）または 200（テストアカウントでログイン成功）

**事後条件:** ステージングで新バージョンが動作している

## RB-002: 本番ロールバック（フィーチャーフラグOFF）
**種別:** ロールバック

**事前条件:** 問題がフィーチャーフラグで制御されている新機能に限定されていること

### 手順

**1. 運用ダッシュボードで該当フィーチャーフラグを OFF に変更**

   期待結果: 新機能が無効化され、旧挙動に切り替わる
   備考: DB マイグレーションは前進のみのため、スキーマは戻さない

**2. ヘルスチェック・主要APIの応答を確認**

   期待結果: 200 OK。エラー率が平常に戻る

**3. リリースログにロールバック事由・実施者・時刻を追記**

   期待結果: document.yaml の releases に rollback_notes を更新

**事後条件:** 本番が旧挙動で安定している

## RB-003: Redis 接続障害時の初動
**種別:** 障害対応

**事前条件:** アラート「Redis connection timeout」が発報されている

### 手順

**1. AWS コンソールで ElastiCache（Redis）のステータスを確認**

   期待結果: クラスターが available か、ノード障害の有無を確認

**2. アプリログで Redis エラー件数・スタックトレースを確認**

   期待結果: 接続タイムアウト・ECONNREFUSED 等の有無
   備考: CloudWatch Logs でフィルタ

**3. Redis 再起動が必要な場合はインフラ担当にエスカレーション**

   期待結果: 再起動後、アプリの再接続が成功する
   備考: トークンストアが Redis のため、再起動中は新規ログイン・リフレッシュが失敗する。事前に周知すること。

**事後条件:** Redis が復旧し、アプリが正常に動作している

## 関連資料（エビデンス）

- [プロジェクト概要](../../../overview/project_summary/human/document.md)
- [環境・インフラ](../../environment/human/document.md)
- [リリースログ](../../../overview/release_log/human/document.md)

---

[プロジェクト概要に戻る](../../../overview/project_summary/human/document.md)