# API設計・改修 記載ガイドライン
# このガイドに従ってYAMLを作成してください

_guide_meta:
  type: api_design
  description: API設計・改修ドキュメントを作成する際のガイドライン
  schema: ../schemas/api_design.schema.json

# ===========================================
# 必須セクション
# ===========================================

meta:
  _guidance: |
    ドキュメントの基本情報を記載します。
    titleはAPI改修の内容が一目でわかるように具体的に書いてください。
  
  title:
    目的: API改修の内容を一言で表す
    ルール:
      - 30文字以上で具体的に
      - 対象APIと改修内容がわかるように
    良い例: "ユーザー情報取得API改修 - ページネーション対応"
    悪い例: "API改修"
  
  type:
    値: api_design  # 固定値
  
  version:
    形式: "X.Y.Z"（例: 1.0.0）
  
  status:
    選択肢:
      - draft: 作成中
      - review: レビュー中
      - approved: 承認済み
      - implemented: 実装完了

background:
  _guidance: |
    なぜこのAPI改修が必要なのか、ビジネス的・技術的な背景を記載します。
  
  purpose:
    目的: 改修の目的を一文で
    ルール:
      - 30文字以上
      - 技術的なメリットを含める
    良い例: "パフォーマンス改善とレスポンス形式の最適化"
    悪い例: "APIを直す"
  
  context:
    目的: 改修が必要になった経緯を詳細に
    ルール:
      - 100文字以上
      - 現状の問題点を具体的に
      - 数値データがあれば記載
    良い例: |
      現行APIはレスポンスに不要なフィールドが多く、
      クライアント側でのパース処理が重くなっている。
      また、N+1問題によりレスポンスタイムが遅い（p99: 2秒）。
  
  issue_links:
    目的: 関連するチケットやIssueへのリンク
    ルール:
      - 1つ以上のリンクを含める

target:
  _guidance: |
    改修対象のAPIを特定します。
  
  api_name:
    目的: APIの名称
    ルール:
      - 正式名称を使用
    良い例: "ユーザー情報取得API"
  
  endpoint:
    目的: エンドポイントのパス
    ルール:
      - パスパラメータは {param} 形式で
    良い例: "/api/v1/users/{user_id}"
  
  method:
    選択肢: [GET, POST, PUT, PATCH, DELETE]
  
  current_version:
    目的: 現在のAPIバージョン
    良い例: "v1"

changes:
  _guidance: |
    具体的な変更内容を列挙します。
    各変更が破壊的かどうかを必ず明記してください。
  
  _ルール:
    - 最低1つ以上の変更を記載
    - 各変更にtype, target, description, reasonを含める
    - breakingフラグを必ず設定
  
  type:
    選択肢:
      - add: 新規追加
      - modify: 既存の変更
      - remove: 削除
      - deprecate: 非推奨化
  
  target:
    目的: 変更対象（パラメータ名、フィールド名など）
    良い例: "fields パラメータ"
    悪い例: "パラメータ"
  
  description:
    目的: 変更内容の説明
    ルール:
      - 30文字以上
      - 何がどう変わるかを具体的に
    良い例: "取得するフィールドを選択できるようにする"
  
  reason:
    目的: なぜこの変更が必要か
    ルール:
      - 30文字以上
      - ビジネス/技術的なメリットを含める
    良い例: "不要なデータ転送を削減するため"
  
  breaking:
    目的: 既存クライアントに影響があるか
    ルール:
      - true: 既存クライアントの修正が必要
      - false: 後方互換性あり

# ===========================================
# 推奨セクション（改修内容によって記載）
# ===========================================

as_is:
  _guidance: |
    現状のAPI仕様を記載します。
    改修の必要性を理解するために、問題点も含めて記載してください。
  
  description:
    目的: 現状の動作を一文で
    良い例: "ユーザー情報と関連データを全て返却している"
  
  request:
    _guidance: |
      現状のリクエスト仕様を記載します。
    headers:
      ルール: 認証ヘッダーなど必要なものを全て記載
    query_params:
      ルール: 各パラメータにname, type, required, descriptionを記載
    body:
      ルール: POST/PUT/PATCHの場合に記載
  
  response:
    _guidance: |
      現状のレスポンス仕様を記載します。
    status_codes:
      ルール: 全てのステータスコードとその意味
    body:
      ルール: レスポンスボディの各フィールド
  
  issues:
    目的: 現状の問題点
    ルール:
      - 3つ以上の問題点を列挙
      - 具体的な数値があれば記載
    良い例:
      - "関連データが全件返却され、レスポンスが大きい（平均500KB）"
      - "N+1クエリが発生している"

to_be:
  _guidance: |
    改修後のAPI仕様を記載します。
    as_isと比較しやすいように同じ形式で記載してください。
  
  description:
    目的: 改修後の動作を一文で
    良い例: "必要なフィールドのみを選択的に返却し、関連データはページネーション対応"

impact:
  _guidance: |
    この改修が影響するシステムを洗い出します。
  
  clients:
    目的: 影響を受けるクライアント/サービス
    ルール:
      - 全ての利用者を列挙
    良い例:
      - "Web フロントエンド（React）"
      - "モバイルアプリ（iOS/Android）"
  
  databases:
    目的: 影響を受けるデータベース/テーブル
  
  dependencies:
    目的: 影響を受ける依存サービス

migration:
  _guidance: |
    破壊的変更がある場合は必ず記載してください。
    段階的な移行計画とロールバック手順を含めてください。
  
  strategy:
    選択肢:
      - big_bang: 一括切替（非推奨）
      - gradual: 段階的移行
      - feature_flag: フィーチャーフラグ
      - versioning: APIバージョニング
  
  steps:
    目的: 移行ステップを順番に
    ルール:
      - 各ステップにorder, description, rollbackを含める
      - ロールバック手順は必須
    良い例:
      - order: 1
        description: v2エンドポイントを新規作成し、並行稼働開始
        rollback: v2エンドポイントを削除
  
  rollback_plan:
    目的: 全体のロールバック計画
    ルール:
      - 50文字以上
      - どの時点でもロールバック可能なことを示す

risks:
  _guidance: |
    改修に伴うリスクを洗い出します。
    破壊的変更がある場合は特に重要です。
  
  _ルール:
    - 最低2つ以上のリスクを検討
    - severity: low/medium/high/critical
    - probability: low/medium/high
    - mitigation は30文字以上で具体的に

testing:
  _guidance: |
    テスト計画を記載します。
  
  unit_tests:
    ルール:
      - 新規追加/変更した機能のテスト
      - エッジケースも含める
  
  integration_tests:
    ルール:
      - 関連サービスとの連携テスト
      - パフォーマンステスト
  
  regression_tests:
    ルール:
      - 既存機能への影響がないことを確認
