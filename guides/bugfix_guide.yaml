# バグ修正設計 記載ガイドライン
# このガイドに従ってYAMLを作成してください

_guide_meta:
  type: bugfix
  description: バグ修正の設計ドキュメントを作成する際のガイドライン
  schema: ../schemas/bugfix.schema.json

# ===========================================
# 必須セクション
# ===========================================

meta:
  _guidance: |
    ドキュメントの基本情報を記載します。
    titleはバグの内容が一目でわかるように具体的に書いてください。
  
  title:
    目的: バグの内容を一言で表す
    ルール:
      - 30文字以上で具体的に
      - 「〜のバグ」「〜の問題」で終わる
    良い例: "ログイン時のセッション重複バグ修正"
    悪い例: "バグ修正"
  
  type:
    値: bugfix  # 固定値
  
  version:
    目的: ドキュメントのバージョン管理
    形式: "X.Y.Z"（例: 1.0.0）
  
  status:
    目的: ドキュメントの状態を示す
    選択肢:
      - draft: 作成中
      - review: レビュー中
      - approved: 承認済み
      - implemented: 実装完了

background:
  _guidance: |
    なぜこのバグ修正が必要なのか、背景を記載します。
    セキュリティや売上への影響など、ビジネスインパクトも含めてください。
  
  purpose:
    目的: バグ修正の目的を一文で
    ルール:
      - 30文字以上
      - 「〜を修正する」で終わる
    良い例: "ログアウト後も別デバイスでセッションが有効なまま残るバグを修正する"
    悪い例: "バグを直す"
  
  context:
    目的: バグが発見された経緯や影響範囲を詳細に
    ルール:
      - 100文字以上
      - いつ、どこで、誰が発見したか
      - どの程度の影響があるか
    良い例: |
      本番環境で複数のユーザーから「ログアウトしたはずなのに
      別のデバイスでログイン状態が維持されている」という報告が
      上がっている。セキュリティ上の問題となる可能性がある。
  
  issue_links:
    目的: 関連するチケットやIssueへのリンク
    ルール:
      - 1つ以上のリンクを含める
      - 有効なURLであること

symptom:
  _guidance: |
    バグの症状を詳細に記載します。
    誰でも再現できるように具体的に書いてください。
  
  description:
    目的: バグの症状を誰でも理解できるように記述
    ルール:
      - 50文字以上
      - 「〜できない」だけでなく「何が起きるか」を具体的に
    良い例: "ログアウト後も別デバイスでセッションが有効なまま残る"
    悪い例: "ログインがおかしい"
  
  frequency:
    目的: バグの発生頻度
    選択肢:
      - always: 常に発生
      - often: 頻繁に発生（50%以上）
      - sometimes: 時々発生（10-50%）
      - rare: 稀に発生（10%未満）
  
  impact:
    目的: バグの影響度
    選択肢:
      - critical: サービス停止レベル
      - major: 主要機能に影響
      - minor: 一部機能に影響
      - trivial: 軽微な問題
  
  affected_users:
    目的: 影響を受けるユーザーの範囲
    ルール:
      - 具体的な数値や割合があれば記載
    良い例: "全ユーザー（特に複数デバイス利用者）"
    悪い例: "一部ユーザー"
  
  reproduction_steps:
    目的: バグを再現する手順
    ルール:
      - 3ステップ以上
      - 各ステップは1つの動作のみ
      - 前提条件も明記
      - 曖昧な表現を避ける
    良い例:
      - "デバイスAでログインする"
      - "デバイスBでログインする"
      - "デバイスAでログアウトする"
      - "デバイスBでページをリロードする"
    悪い例:
      - "ログインする"
      - "ログアウトする"
  
  expected_behavior:
    目的: 本来どう動作すべきか
    ルール:
      - 30文字以上
      - 具体的な動作を記述
    良い例: "デバイスAでログアウトしたら、全デバイスでログアウトされる"
  
  actual_behavior:
    目的: 実際にはどう動作しているか
    ルール:
      - 30文字以上
      - expected_behaviorと対比できるように
    良い例: "デバイスAでログアウトしても、デバイスBではログイン状態が継続する"
  
  error_logs:
    目的: 関連するエラーログやスタックトレース
    ルール:
      - 実際のログをコピー
      - 個人情報はマスク

root_cause:
  _guidance: |
    バグの根本原因を特定し、なぜそのバグが発生したのかを分析します。
    表面的な原因ではなく、根本原因まで掘り下げてください。
  
  description:
    目的: 根本原因を技術的に説明
    ルール:
      - 50文字以上
      - コードレベルで何が問題かを明記
    良い例: |
      ログアウト処理でセッション削除にRedisのDELコマンドを使用しているが、
      ユーザーの全セッションを取得するSCANがタイムアウトし、
      一部のセッションが削除されずに残っている。
    悪い例: "セッション管理に問題がある"
  
  location:
    目的: 問題のあるコードの場所を特定
    ルール:
      - ファイルパスを正確に
      - 行番号も可能であれば
      - 関数/メソッド名も記載
    例:
      file: src/services/auth/session.ts
      line: 145
      function: clearUserSessions
  
  why_analysis:
    目的: なぜなぜ分析（5 Whys）で根本原因を掘り下げる
    ルール:
      - 3段階以上の深掘り
      - 各「なぜ」に対して具体的な回答
      - 技術的な原因だけでなく、プロセスの問題も含める
    良い例:
      - why: "なぜセッションが残るのか？"
        answer: "SCANコマンドがタイムアウトして全セッションを取得できていない"
      - why: "なぜSCANがタイムアウトするのか？"
        answer: "セッションキーが多すぎてスキャンに時間がかかる"
      - why: "なぜセッションキーが多いのか？"
        answer: "有効期限切れのセッションが削除されずに蓄積している"
  
  introduced_by:
    目的: バグが混入した原因（PR/コミット）を特定
    ルール:
      - 可能であればPR番号やコミットハッシュを記載
    良い例: "PR #456 (2025-11-15) - セッション管理のリファクタリング"

fix:
  _guidance: |
    バグの修正方法を記載します。
    修正前後のコードを示し、なぜその修正が適切かを説明してください。
  
  approach:
    目的: 修正のアプローチを説明
    ルール:
      - 50文字以上
      - 複数の修正がある場合は番号付きで
    良い例: |
      1. セッション作成時に必ずTTLを設定するよう修正
      2. ログアウト時のセッション削除をバッチ処理に変更
      3. 既存の孤立セッションをクリーンアップするバッチを実行
  
  changes:
    目的: 具体的なコード変更を記載
    ルール:
      - 変更するファイルごとに記載
      - before/afterでコードを示す
      - 変更理由も記載
    例:
      - file: src/services/auth/session.ts
        description: セッション作成時のTTL設定漏れを修正
        before: |
          if (rememberMe) {
            await redis.set(sessionKey, sessionData);
            await redis.expire(sessionKey, LONG_TTL);
          } else {
            await redis.set(sessionKey, sessionData);
          }
        after: |
          const ttl = rememberMe ? LONG_TTL : SHORT_TTL;
          await redis.set(sessionKey, sessionData, 'EX', ttl);
  
  side_effects:
    目的: 修正による副作用を洗い出す
    ルール:
      - 想定される副作用をすべて列挙
      - 対処法も記載

# ===========================================
# 推奨セクション
# ===========================================

verification:
  _guidance: |
    修正が正しいことを確認するためのテスト計画を記載します。
  
  test_cases:
    目的: 修正を検証するテストケース
    ルール:
      - 最低3つ以上のテストケース
      - 正常系と異常系の両方
      - 期待結果を明確に
    例:
      - description: 複数デバイスログイン時の一括ログアウト
        steps:
          - デバイスAでログインする
          - デバイスBでログインする
          - デバイスAでログアウトする
          - デバイスBでページをリロードする
        expected_result: デバイスBでもログアウト状態になっている
  
  environments:
    目的: 検証を行う環境
    ルール:
      - 本番環境に近い環境で検証

prevention:
  _guidance: |
    同様のバグを再発させないための対策を記載します。
  
  immediate_actions:
    目的: 今すぐ行う対策
    ルール:
      - 具体的なアクション
      - 担当者を決められるレベルで
  
  long_term_actions:
    目的: 長期的に行う対策
    ルール:
      - プロセス改善やツール導入など

risks:
  _guidance: |
    修正に伴うリスクを洗い出します。
  
  _ルール:
    - 最低2つ以上のリスクを検討
    - severity と probability を必ず設定
    - mitigation（対策）は30文字以上で具体的に

testing:
  _guidance: |
    テスト計画を記載します。
  
  _ルール:
    - unit_tests, integration_tests は最低2項目ずつ
    - regression_tests で既存機能への影響がないことを確認
