# インフラ構築設計 記載ガイドライン
# このガイドに従ってYAMLを作成してください

_guide_meta:
  type: infrastructure
  description: インフラ・環境構築の設計ドキュメントを作成する際のガイドライン
  schema: ../schemas/infrastructure.schema.json

# ===========================================
# 必須セクション
# ===========================================

meta:
  _guidance: |
    ドキュメントの基本情報を記載します。
    titleはインフラ変更の内容が一目でわかるように具体的に書いてください。
  
  title:
    目的: インフラ変更の内容を一言で表す
    ルール:
      - 20文字以上で具体的に
    良い例: "Kubernetes移行プロジェクト"
    悪い例: "インフラ構築"
  
  type:
    値: infrastructure  # 固定値
  
  version:
    形式: "X.Y.Z"（例: 1.0.0）
  
  status:
    選択肢:
      - draft: 作成中
      - review: レビュー中
      - approved: 承認済み
      - implemented: 実装完了

background:
  _guidance: |
    なぜこのインフラ変更が必要なのか、ビジネス的・技術的な背景を記載します。
  
  purpose:
    目的: 変更の目的を一文で
    ルール:
      - 30文字以上
      - 期待される効果を含める
    良い例: "EC2ベースのインフラをKubernetesに移行し、運用効率とスケーラビリティを向上"
    悪い例: "インフラを変える"
  
  context:
    目的: 変更が必要になった背景を詳細に
    ルール:
      - 100文字以上
      - 現状の課題を具体的に
      - 数値データがあれば記載

scope:
  _guidance: |
    この設計でカバーする範囲を明確にします。
  
  in:
    目的: この設計でカバーする範囲
    良い例:
      - "APIサーバー（3サービス）"
      - "バックグラウンドワーカー"
      - "監視・ログ基盤"
  
  out:
    目的: この設計でカバーしない範囲
    良い例:
      - "データベース（RDSのまま維持）"
      - "CDN設定"

target_state:
  _guidance: |
    目標とするインフラ構成を記載します。
    現状との差分がわかるように詳細に記載してください。
  
  description:
    目的: 目標の構成を一文で
    ルール:
      - 30文字以上
    良い例: "EKS上でのコンテナオーケストレーション"
  
  components:
    目的: 目標構成のコンポーネント
    ルール:
      - 各コンポーネントにname, type, technology, descriptionを含める
      - connectionsで他コンポーネントとの関係を示す
    
    type:
      選択肢:
        - server: 物理/仮想サーバー
        - container: コンテナ
        - serverless: サーバーレス
        - database: データベース
        - cache: キャッシュ
        - queue: メッセージキュー
        - storage: ストレージ
        - network: ネットワーク機器
        - cdn: CDN
        - other: その他
    
    良い例:
      - name: API Server
        type: container
        technology: EKS (Kubernetes)
        description: Deployment + HPA、最小3Pod
        connections:
          - RDS
          - ElastiCache
  
  benefits:
    目的: この構成にするメリット
    ルール:
      - 3つ以上のメリットを列挙
    良い例:
      - "オートスケーリングで負荷に自動対応"
      - "ローリングデプロイでダウンタイムゼロ"

# ===========================================
# 推奨セクション
# ===========================================

current_state:
  _guidance: |
    現状のインフラ構成を記載します。
    target_stateと比較しやすい形式で。
  
  description:
    目的: 現状の構成を一文で
  
  components:
    目的: 現状のコンポーネント
  
  issues:
    目的: 現状の問題点
    ルール:
      - 3つ以上の問題点を列挙
    良い例:
      - "スケーリングに10分以上かかる"
      - "デプロイ時に5分程度のダウンタイムが発生"

resources:
  _guidance: |
    必要なリソースを詳細に記載します。
    コスト見積もりの根拠にもなります。
  
  compute:
    目的: コンピュートリソース
    ルール:
      - 各リソースにname, type, count, specsを含める
    良い例:
      - name: EKS Node Group
        type: t3.large
        count: 3
        specs:
          cpu: 2 vCPU
          memory: 8 GB
          storage: 50 GB
  
  services:
    目的: 使用するマネージドサービス
    ルール:
      - providerとservice_typeを明記
    良い例:
      - name: EKS
        provider: AWS
        service_type: Managed Kubernetes
        config:
          version: "1.28"

security:
  _guidance: |
    セキュリティ設計を記載します。
    本番環境では必須です。
  
  authentication:
    目的: 認証方式
    良い例: "IAM + OIDC Provider"
  
  authorization:
    目的: 認可方式
    良い例: "Kubernetes RBAC"
  
  encryption:
    目的: 暗号化設定
    at_rest:
      目的: 保存時の暗号化
      良い例: "EBS暗号化 (AWS KMS)"
    in_transit:
      目的: 通信時の暗号化
      良い例: "TLS 1.3"
  
  compliance:
    目的: 準拠する規格
    良い例:
      - "SOC 2"
      - "ISO 27001"

monitoring:
  _guidance: |
    監視設計を記載します。
  
  metrics:
    目的: 監視するメトリクス
    ルール:
      - 各メトリクスにname, threshold, alert_conditionを含める
    良い例:
      - name: Pod CPU使用率
        threshold: 80%
        alert_condition: 5分間平均が閾値超過
  
  logging:
    目的: ログ設定
    ルール:
      - destinationとretention_daysを含める
  
  alerting:
    目的: アラート設定
    ルール:
      - 通知先とエスカレーションポリシー

migration:
  _guidance: |
    移行計画を記載します。
    ダウンタイムを最小化する戦略を選んでください。
  
  strategy:
    選択肢:
      - lift_and_shift: そのまま移行
      - replatform: プラットフォーム変更
      - refactor: リアーキテクチャ
      - blue_green: ブルー/グリーン
      - canary: カナリアリリース
  
  steps:
    目的: 移行ステップ
    ルール:
      - 各ステップにorder, description, rollbackを含める
      - ロールバック手順は必須
  
  rollback_plan:
    目的: 全体のロールバック計画
    ルール:
      - 50文字以上
  
  downtime_window:
    目的: 想定ダウンタイム
    良い例: "ゼロダウンタイム（ブルー/グリーンデプロイ）"

cost:
  _guidance: |
    コスト見積もりを記載します。
  
  monthly_estimate:
    目的: 月額概算
    良い例: "$2,500"
  
  breakdown:
    目的: コスト内訳
    ルール:
      - 主要な項目を列挙
    良い例:
      - item: EKS Control Plane
        cost: "$73"
      - item: EC2 (Node Group)
        cost: "$500"
  
  notes:
    目的: 備考（現行との比較など）
    良い例: |
      現行のEC2環境（月額$2,200）と比較して約$300増加だが、
      運用工数削減とスケーラビリティ向上を考慮するとROIは良好。

risks:
  _guidance: |
    インフラ変更に伴うリスクを洗い出します。
  
  _ルール:
    - 最低3つ以上のリスクを検討
    - 移行時のリスクと運用時のリスクの両方

testing:
  _guidance: |
    インフラのテスト計画を記載します。
  
  unit_tests:
    ルール:
      - IaCコードのテスト
    良い例:
      - "Kubernetesマニフェストのバリデーション"
      - "Helmチャートのテスト"
  
  integration_tests:
    ルール:
      - サービス間の連携テスト
    良い例:
      - "クラスター内サービス間通信"
      - "オートスケーリングの動作確認"
  
  regression_tests:
    ルール:
      - 既存機能のテスト
    良い例:
      - "APIの機能テスト"
      - "負荷テスト（現行同等の負荷を処理できること）"
