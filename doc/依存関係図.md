# doc_type と human/document.md の依存関係図

各 doc_type では `ai/document.yaml` を `tool/create_human_document.py` が読み、`human/document.md` を生成する。大多数は**単体変換**（自分の YAML のみ参照）だが、一部の doc_type は**他 doc_type の ai/document.yaml を tool で取得**し、その情報を human/document.md に含めて生成している。本ドキュメントではそれらを全て含めた依存関係を図示する。

参照: [ABOUT.md](ABOUT.md)、[README.md](../README.md)

---

## 1. 依存の種類

| 種類 | 説明 | 該当 doc_type / ツール |
|------|------|-------------------------|
| **単体変換** | 当該 doc_type の `ai/document.yaml` のみを読み、`human/document.md` を 1 件生成する。 | 大多数の doc_type（release_log, tasks, open_items, requirements など） |
| **他 YAML 参照して集約** | 自分の YAML に加え、他 doc_type の `ai/document.yaml` を tool で読み、human/document.md に集約表示する。 | overview/wbs、overview/project_summary |
| **common ツールによる集約** | doc_type の human/document.md ではなく、別の 1 つの Markdown を生成する。 | build_open_items_aggregate.py |

---

## 2. 図1 — 基本パターン（単体 doc_type）

1 つの doc_type あたり、自分の `ai/document.yaml` のみを `tool/create_human_document.py` が読み、`human/document.md` を 1 件出力する。common（paths, md_base, config, scheme）を利用する。

```mermaid
flowchart LR
  subgraph one_doc_type [1 doc_type 例: release_log]
    ay[ai/document.yaml]
    cr[tool/create_human_document.py]
    hd[human/document.md]
  end
  common[common: paths, md_base, config, scheme]
  ay -->|入力| cr
  common -->|利用| cr
  cr -->|出力| hd
```

---

## 3. 図2 — overview/wbs の依存

WBS の `human/document.md` は、自分の `overview/wbs/ai/document.yaml` に加え、**全 (category, doc_type) の ai/document.yaml** を読み、ドキュメント状態・タスク一覧（「カテゴリ別タスク状態」）を集約する。さらに **design/tasks, development/tasks, investigation/tasks, verification/tasks** の各 `ai/document.yaml` を読み、「カテゴリ別詳細タスク」セクションを生成する。

```mermaid
flowchart TB
  subgraph wbs_tool [overview/wbs/tool/create_human_document.py]
    collect_task_states[collect_task_states: 全 doc_type]
    collect_category_tasks[collect_category_tasks: 各 tasks]
  end
  wbs_yaml[overview/wbs/ai/document.yaml]
  all_yaml[全 category x doc_type の ai/document.yaml]
  tasks_design[design/tasks/ai/document.yaml]
  tasks_dev[development/tasks/ai/document.yaml]
  tasks_inv[investigation/tasks/ai/document.yaml]
  tasks_ver[verification/tasks/ai/document.yaml]
  wbs_md[overview/wbs/human/document.md]

  wbs_yaml --> wbs_tool
  all_yaml --> collect_task_states
  tasks_design --> collect_category_tasks
  tasks_dev --> collect_category_tasks
  tasks_inv --> collect_category_tasks
  tasks_ver --> collect_category_tasks
  collect_task_states --> wbs_md
  collect_category_tasks --> wbs_md
  wbs_tool --> wbs_md
```

---

## 4. 図3 — overview/project_summary の依存

project_summary の `human/document.md` は、自分の `overview/project_summary/ai/document.yaml` に加え、**自分以外の全 (category, doc_type) の ai/document.yaml** を `get_all_doc_links()` で読み、`meta.title` を取得して「カテゴリ別ドキュメント一覧」のリンクを生成する。

```mermaid
flowchart TB
  subgraph ps_tool [overview/project_summary/tool/create_human_document.py]
    get_all_doc_links[get_all_doc_links]
  end
  ps_yaml[overview/project_summary/ai/document.yaml]
  other_yaml[それ以外の全 ai/document.yaml]
  ps_md[overview/project_summary/human/document.md]

  ps_yaml --> ps_tool
  other_yaml --> get_all_doc_links
  get_all_doc_links --> ps_md
  ps_tool --> ps_md
```

---

## 5. 図4 — build_open_items_aggregate

common ツール `build_open_items_aggregate.py` は、全カテゴリの `open_items/ai/document.yaml` を読み、1 つの集約 Markdown を生成する。出力先はオプション指定可能。各 doc_type の human/document.md とは別の成果物である。

```mermaid
flowchart TB
  agg[common/tools/build_open_items_aggregate.py]
  oi_overview[overview/open_items/ai/document.yaml]
  oi_design[design/open_items/ai/document.yaml]
  oi_dev[development/open_items/ai/document.yaml]
  oi_inv[investigation/open_items/ai/document.yaml]
  oi_ver[verification/open_items/ai/document.yaml]
  md_agg[検討事項一覧 MD]

  oi_overview --> agg
  oi_design --> agg
  oi_dev --> agg
  oi_inv --> agg
  oi_ver --> agg
  agg --> md_agg
```

---

## 6. 図5 — ビルド全体

`build.py` は各 YAML に対して validate を実行した後、当該 doc_type の create_human_document を実行する。WBS と project_summary のスクリプトは実行時に上記の他 YAML を読みにいくため、図2・図3の依存がここに統合される。

```mermaid
flowchart TB
  subgraph build [build.py]
    validate[validate.py]
    run_create[各 doc_type の create_human_document.py 実行]
  end
  all_ai[全 ai/document.yaml]
  schema[ai/scheme.json]
  wbs_script[overview/wbs/tool]
  ps_script[overview/project_summary/tool]
  other_scripts[その他 doc_type の tool]
  all_md[全 human/document.md]

  all_ai --> validate
  schema --> validate
  validate --> run_create
  all_ai --> wbs_script
  all_ai --> ps_script
  all_ai --> other_scripts
  wbs_script --> all_md
  ps_script --> all_md
  other_scripts --> all_md
```

---

## 7. doc_type 別の依存一覧

| カテゴリ | doc_type | human/document.md の生成に参照する ai/document.yaml |
|----------|----------|------------------------------------------------------|
| overview | wbs | **自分 + 全 (category, doc_type)**（タスク状態用）+ **design/tasks, development/tasks, investigation/tasks, verification/tasks**（カテゴリ別詳細タスク用） |
| overview | project_summary | **自分 + 自分以外の全 (category, doc_type)**（リンク一覧のタイトル取得用） |
| 上記以外 | すべて | **当該 doc_type の ai/document.yaml のみ** |

集約系（他 YAML を tool で参照して human/document.md を生成する）は **overview/wbs** と **overview/project_summary** の 2 件のみ。
